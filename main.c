#include <stm32f10x.h>
#include "string.h"
#include "ledscreen.h"
#include "delay.h"
#include "usart.h"
#include "driversInit.h"
#include "GlobalVar.h"
#include "led.h"
#include "relay.h"
#include "di.h"
#include "tts.h"
#include "usart.h"


/****************************** Macro Definition ******************************/
#define LED_RUNNING_PERIOD		1000

/****************************** Function Declaration ******************************/
void initDrivers(void);
void workloop( void);

 u8 databuff[]={0xFD,0x00,0x2C,0x01,0x01,0x5B,0x6D,0x35,0x31,0x5D,0x5B,0x62,0x30,0x5D,0xBB,0xB6,0xD3,0xAD,0xB9,0xE2,
 0xC1,0xD9,0xA3,0xAC,0xD2,0xBB,0xC2,0xB7,0xCB,0xB3,0xB7,0xE7,0xA3,0xAC,
 0xCD,0xA3,0xB3,0xB5,0xB7,0xD1,0x31,0x35,0xD4,0xAA,0x5B,0x64,0x5D};
 
void flash_running_led()
{
	static uint8_t	ledStatus	= 0;
	static uint32_t runningTick	= 0;
    
	if ( timeout( runningTick, LED_RUNNING_PERIOD ) )
	{
		if ( ledStatus == 0 )
		{
			LED_ON( LED_NO_1 );
			ledStatus = 1;
		} else {
			LED_OFF( LED_NO_1 );
			ledStatus = 0;
		}
		//printf("usart debug\n\r");
		runningTick = local_ticktime();
	}
}

int receiveByteFromBoard_A( enum BOARD_USART_TYPE usart_no, unsigned char recv) {
	_usart_sendstring(USART1,databuff,2);
	_usart_sendstring(USART3,databuff,sizeof(databuff));
	return 0;
}
int receiveByteUsingUsart2( enum BOARD_USART_TYPE usart_no, unsigned char recv) {
	//_usart_sendstring(USART2,databuff,2);
	return 0;
}
int receiveByteFromTTS( enum BOARD_USART_TYPE usart_no, unsigned char recv) {
	//if(recv==0x4A	){LED_ON( LED_NO_1 );
	//	_usart_sendstring(USART3,databuff,sizeof(databuff));
	//}
	return 0;
}

int main()
{   
		initDrivers();

		workloop();
}

void initDrivers(void) {
	SystemInit();
	RCC_Configuration();
	__disable_irq();
	
	GPIO_PinRemapConfig(GPIO_Remap_SWJ_JTAGDisable,ENABLE);
	init_tts();
	init_led();
	init_relay();
	init_di();
	init_usart();
	init_ledscreen();
	
	__enable_irq();
}

void workloop(void )
{    
    const u8 ZiMu1[][32]={
        {0x04,0x00,0x04,0x00,0x04,0x00,0x04,0x00,0x7F,0xE0,0x04,0x20,0x04,0x20,0x04,0x20,
        0x08,0x20,0x08,0x20,0x08,0x20,0x10,0x22,0x10,0x22,0x20,0x22,0x40,0x1E,0x80,0x00},/*"¾Å",0*/
        {0x01,0x00,0x11,0x00,0x11,0x00,0x11,0x00,0x1F,0xF8,0x21,0x00,0x41,0x00,0x01,0x00,
        0x01,0x00,0xFF,0xFE,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00},/*"Å£",1*/
        {0x01,0x00,0x01,0x00,0x01,0x00,0x3F,0xF8,0x21,0x08,0x21,0x08,0x21,0x08,0x3F,0xF8,
        0x21,0x08,0x21,0x08,0x21,0x08,0x3F,0xF8,0x21,0x0A,0x01,0x02,0x01,0x02,0x00,0xFE},/*"µç",2*/
        {0x00,0x00,0x7F,0xF8,0x00,0x10,0x00,0x20,0x00,0x40,0x01,0x80,0x01,0x00,0xFF,0xFE,
        0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x05,0x00,0x02,0x00},/*"×Ó",3*/
        {0x00,0x80,0x00,0x80,0xFC,0x80,0x04,0xFC,0x05,0x04,0x49,0x08,0x2A,0x40,0x14,0x40,
        0x10,0x40,0x28,0xA0,0x24,0xA0,0x45,0x10,0x81,0x10,0x02,0x08,0x04,0x04,0x08,0x02},/*"»¶",4*/
        {0x00,0x00,0x20,0x80,0x13,0x3C,0x12,0x24,0x02,0x24,0x02,0x24,0xF2,0x24,0x12,0x24,
        0x12,0x24,0x12,0xB4,0x13,0x28,0x12,0x20,0x10,0x20,0x28,0x20,0x47,0xFE,0x00,0x00},/*"Ó­",5*/
        {0x09,0x00,0x09,0x00,0x11,0xFC,0x32,0x04,0x54,0x48,0x99,0x50,0x11,0x48,0x12,0x44,
        0x14,0x44,0x11,0x40,0x10,0x80,0x02,0x00,0x51,0x04,0x51,0x12,0x90,0x12,0x0F,0xF0},/*"Äú",6*/
        {0x00,0x00,0x10,0x00,0x10,0x00,0x10,0x00,0x10,0x00,0x10,0x00,0x10,0x00,0x10,0x00,
        0x10,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x10,0x00,0x00,0x00,0x00,0x00}/*"£¡",7*/
    };

		uint8_t DisBuf[16][10];
		
	memset(DisBuf,0,160);	
	loadWordIntoBuffer(DisBuf,0,ZiMu1[0]);
	loadWordIntoBuffer(DisBuf,2,ZiMu1[1]);
	loadWordIntoBuffer(DisBuf,4,ZiMu1[2]);
	loadWordIntoBuffer(DisBuf,6,ZiMu1[3]);
  loadWordIntoBuffer(DisBuf,8,ZiMu1[4]);

	POWER_ON_TTS();
	MUTE_OFF_TTS();
	//_usart_sendstring(USART3,databuff,sizeof(databuff));
	while(1) {
		flash_running_led(); 
		
		LedScreenDisplayBuffer( LEDSCREEN_NO_1, DisBuf );
		LedScreenDisplayBuffer( LEDSCREEN_NO_2, DisBuf );
  }        
}


